---
title: "Data_Modeling"
output: html_document
---

## Import Libraries
```{r}
library(dplyr)
library(tidyverse)
library(rstan)
library(ggmcmc)
```

## Load In Cleaned Data
```{r}
df <- read_csv('Cleaned_Dataset.csv')
```

## Create Models!
```{r Data_block}

teams <- unique(c(df$team_home, df$team_away))
team_ids <- setNames(seq_along(teams), teams)

df <- df %>% mutate(
  home_team_id = team_ids[team_home],
  away_team_id = team_ids[team_away]
)

reg_df <- df %>% filter(!grepl(paste(c('_18_', "_19_", "_20_", "_21_", "_22_", "_23_"), collapse = "|"), game_id))
wc_df <- df %>% filter(!grepl(paste(c('_18_', "_20_", "_21_", "_22_", "_23_"), collapse = "|"), game_id))
div_df <- df %>% filter(!grepl(paste(c('_18_', "_21_", "_22_", "_23_"), collapse = "|"), game_id))
conf_df <- df %>% filter(!grepl(paste(c('_18_', "_22_", "_23_"), collapse = "|"), game_id))

dfs <- list(reg_df, wc_df, div_df, conf_df)
tags <- c("reg", "wc", "div", "conf")

for (i in seq_along(dfs)) {
  
  df <- dfs[[i]]
  tag <- tags[i]
  
  stan_data <- list(
    N = nrow(df),
    T = length(team_ids),
    home_team = df$home_team_id,
    away_team = df$away_team_id,
    home_rush_td = df$rush_touchdown_home,
    away_rush_td = df$rush_touchdown_away,
    home_pass_td = df$pass_touchdown_home,
    away_pass_td = df$pass_touchdown_away,
    home_ret_td = df$return_touchdown_home,
    away_ret_td = df$return_touchdown_away,
    home_def_td = df$def_touchdown_home,
    away_def_td = df$def_touchdown_away,
    home_fg = df$field_goal_made_home,
    away_fg = df$field_goal_made_away,
    home_safeties = df$safety_home,
    away_safeties = df$safety_away,
    
    home_exp_attempt = df$extra_point_attempt_home,
    home_exp = df$extra_point_good_home,
    away_exp_attempt = df$extra_point_attempt_away,
    away_exp = df$extra_point_good_away,
    home_2p_attempt = df$two_point_attempt_home,
    home_2p = df$two_point_success_home,
    away_2p_attempt = df$two_point_attempt_away,
    away_2p = df$two_point_success_away,
    
    home_td = df$touchdown_home,
    away_td = df$touchdown_away
  )
  
  print(paste("Fitting", tag, "Model"))
  
  fit <- stan(
    file = 'scoring.stan',
    data = stan_data,
    iter = 10000,
    warmup = 1000,
    chains = 4,
    cores = -1,
    seed = 24,
    thin = 1,
    init = 'random'
  )
  
  traceplot(fit, pars = c('int_td_rush', 'int_td_pass', 'int_fg', 'home_advantage_pass', 'home_advantage_rush', 'home_advantage_fg'))

  saveRDS(fit, paste0(tag, ".rds")) 
}
```


## Create a TracePlot of Intercepts
```{r}
fit <- readRDS("reg.rds")
traceplot(fit, pars = c('int_td_rush', 'int_td_pass', 'int_td_ret', 'int_td_def',
                        'int_safety', 'int_fg', "home_advantage_rush", "home_advantage_pass", "home_advantage_fg"))
```


