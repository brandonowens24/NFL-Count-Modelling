---
title: "Data_PreProcessing"
output: html_document
---

## Import Libraries
```{r Imports}
library(dplyr)
library(readr)
library(zoo)
library(purrr)
library(tidyverse)
library(ggplot2)
library(ggrepel)
```

## Read In Sports Lines
```{r Load}
df = read.csv('nfl_data.csv')
lines <- read.csv("Historical_Lines.csv")
```

## Grab Desired Cols
```{r filter_data}
df_filtered <- df %>%
  arrange(game_id) %>%
  select(posteam, season, game_id, home_team, away_team, home_score, away_score, touchdown, extra_point_attempt, extra_point_good,
         field_goal_attempt, field_goal_made, return_touchdown, two_point_attempt, two_point_success, pass_touchdown, rush_touchdown, safety)
```

## Create Home/Away Cols
```{r split_home_away}
home_data <- df_filtered %>% filter(posteam == home_team) %>%
  mutate(
    team = home_team,
    score = home_score
  ) %>%
  select(-one_of(c('home_team', 'away_team','home_score', 'away_score')))

away_data <- df_filtered %>% filter(posteam == away_team) %>%
  mutate(
    team = away_team,
    score = away_score
  ) %>%
  select(-one_of(c('home_team', 'away_team','home_score', 'away_score')))
```

## Combine Home/Away Cols
```{r combine_gbg}
game_data <- home_data %>% 
  inner_join(away_data, by = "game_id", suffix = c('_home', '_away'))

game_data$def_touchdown_home <- game_data$touchdown_home - (game_data$return_touchdown_home + game_data$pass_touchdown_home + game_data$rush_touchdown_home)
game_data$def_touchdown_away <- game_data$touchdown_away - (game_data$return_touchdown_away + game_data$pass_touchdown_away + game_data$rush_touchdown_away)


write_csv(game_data, 'Cleaned_Dataset.csv')
```

## Create Subsets For Each Playoff Round
```{r show_mov}
patterns <- c("_18_", "_19_", "_20_", "_21_", "_22_", "_23_")

game_data <- game_data %>%
  filter(!grepl(paste(patterns, collapse = "|"), game_id))
ranks <- game_data %>%
  mutate(
    home_mov = score_home - score_away,
    away_mov = score_away - score_home,
    home_win = home_mov >0,
    away_win = home_mov < 0
  )


ranks <- ranks %>%
  select(team=team_home, score = score_home, opp_score = score_away, mov = home_mov, win = home_win, loss=away_win) %>%
  bind_rows(
    ranks %>%
      select(team=team_away, score = score_away, opp_score = score_home, mov = away_mov, win = away_win, loss=home_win)
  )

ranks <- ranks %>% group_by(team) %>%
  summarise(mov = mean(mov), wl =(sum(win) / (sum(win) + sum(loss)))) %>%
  arrange(desc(mov))
```

## Create MOV Plot
```{r}
ggplot(ranks, aes(reorder(team, mov), y = mov, fill = mov)) +
  geom_bar(stat = "identity") +
  scale_fill_distiller(palette = "Spectral") +
  coord_flip() +
  labs(x = "Team", y = "Average MOV", fill = "MOV") +
  theme_minimal()
```

## Create Plot for MOV vs. WL Ratio
```{r}
ggplot(ranks, aes(x = mov, y = wl, label = team)) +
  geom_point(size=2) +
  geom_smooth(method = lm) +
  geom_text_repel() + 
  labs(x = "Average MOV", y = "Win/Loss Ratio") +
  theme_minimal()
```

```{r}
game_data_long <- game_data %>%
  pivot_longer(cols = c(touchdown_home, touchdown_away),
               names_to = "team_type",
               values_to = "touchdowns")

ggplot(game_data_long, aes(x = touchdowns)) +
  geom_bar() +
  labs(x = "Touchdowns", y = "Count") +
  theme(plot.title = element_text(hjust=0.5)) +
  ggtitle('2024-2025 Touchdown Counts by Game')

```
```{r}
mean_td <- mean(c(game_data$touchdown_home, game_data$touchdown_away))
sim_pois <- rpois(5000, mean_td)

ex_df <- data.frame('touchdowns'=sim_pois)

ggplot(ex_df, aes(x = touchdowns)) +
  geom_bar() + 
  theme(plot.title = element_text(hjust=0.5)) +
  xlim(c(-0.5,7.5)) +
  ggtitle('Poisson Distribution w/ Mean TD Lambda') +
  theme(axis.title.x = element_blank(), axis.title.y = element_blank()) 
```

