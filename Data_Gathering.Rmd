---
title: "Data_Gathering"
output: html_document
---

## Import Libraries
```{r load_lib}
library(nflreadr)
library(tidyr)
library(dplyr)
```

## Load Play-By-Play NFL Data
```{r grab_pbp}

# GRAB PBP DATA
data <- load_pbp(2024)

data <- data %>% filter(week != 18)

```

## Filter Scoring Opportunities
```{r filter_data}

# FILTER DATA TO GET DESIRED COLS
subset <- subset(data,
       (
         touchdown == 1 |
         (fourth_down_converted == 1 |
         fourth_down_failed == 1) |
         punt_inside_twenty == 1 |
         own_kickoff_recovery == 1 |
         extra_point_attempt == 1 |
         # extra_point_result == "good" |
         field_goal_attempt == 1 |
         field_goal_result == "made" |
         return_touchdown == 1 |
         two_point_attempt == 1 |
         # two_point_conv_result == "success" |
         pass_touchdown == 1 |
         rush_touchdown == 1 | 
         interception == 1 |
         fumble_lost == 1 |
         safety == 1
       ),
       select = c(
         season_type,
         season,
         game_id,
         home_team,
         away_team,
         home_score,
         away_score,
         posteam,
         defteam,
         fourth_down_failed,
         fourth_down_converted,
         td_team,
         touchdown,
         punt_inside_twenty,
         own_kickoff_recovery,
         extra_point_attempt,
         extra_point_result,
         field_goal_attempt,
         field_goal_result,
         return_touchdown,
         two_point_attempt,
         two_point_conv_result,
         pass_touchdown,
         rush_touchdown,
         interception,
         fumble_lost,
         safety))
```

## Mutate Successes
```{r mutate_cols}

# GRAB SUCCESSES
subset_mutated <- subset %>%
  mutate(
    extra_point_good = extra_point_result == "good",
    field_goal_made = field_goal_result == "made",
    two_point_success = two_point_conv_result == "success"
  )

```

## Create Team Summaries for Each Game
```{r summarize}

# SUMMARIZE SUCCESSES
data_summ <- subset_mutated %>%
  group_by(game_id, posteam) %>%
  summarize(
    season_type = first(season_type),
    season = first(season),
    home_team = first(home_team),
    away_team = first(away_team),
    home_score = first(home_score),
    away_score = first(away_score),
    touchdown = sum(touchdown == 1, na.rm = TRUE),
    punt_inside_twenty = sum(punt_inside_twenty == 1, na.rm = TRUE),
    own_kickoff_recovery = sum(own_kickoff_recovery == 1, na.rm = TRUE),
    extra_point_attempt = sum(extra_point_attempt ==1, na.rm = TRUE),
    extra_point_good = sum(extra_point_good == 1, na.rm = TRUE),
    field_goal_attempt = sum(field_goal_attempt == 1, na.rm = TRUE),
    field_goal_made = sum(field_goal_made == 1, na.rm = TRUE),
    return_touchdown = sum(return_touchdown == 1, na.rm = TRUE),
    two_point_attempt = sum(two_point_attempt ==1, na.rm=TRUE),
    two_point_success = sum(two_point_success == 1, na.rm = TRUE),
    pass_touchdown = sum(pass_touchdown == 1, na.rm = TRUE),
    rush_touchdown = sum(rush_touchdown == 1, na.rm = TRUE),
    interception = sum(interception == 1, na.rm = TRUE),
    fumble_lost = sum(fumble_lost == 1, na.rm = TRUE),
    safety = sum(safety == 1, na.rm = TRUE)
  )
```

## Clean Team Names
```{r retention}

# CREATE A TEAM DICT
team_abbr_map <- c(
  ARI = "ARI",
  ARZ = "ARI",
  ATL = "ATL",
  BAL = "BAL",
  BLT = "BAL",
  BUF = "BUF",
  CAR = "CAR",
  CHI = "CHI",
  CIN = "CIN",
  CLE = "CLE",
  CLV = "CLE",
  DAL = "DAL",
  DEN = "DEN",
  DET = "DET",
  GB  = "GB",
  HOU = "HOU",
  HST = "HOU",
  IND = "IND",
  JAX = "JAX",
  KC  = "KC",
  LA  = "LA",
  LAC = "LAC",
  LV  = "LV",
  MIA = "MIA",
  MIN = "MIN",
  NE  = "NE",
  NO  = "NO",
  NYG = "NYG",
  NYJ = "NYJ",
  OAK = "LV",
  PHI = "PHI",
  PIT = "PIT",
  SD  = "LAC",
  SEA = "SEA",
  SF  = "SF",
  SL  = "LA",
  TB  = "TB",
  TEN = "TEN",
  WAS = "WAS"
)

# MAP TEAM ABBR
data_summ <- data_summ %>%
  mutate(home_team = recode(home_team, !!!team_abbr_map),
         away_team = recode(away_team, !!!team_abbr_map))


```

## Create CSV
```{r save_data}
write.csv(data_summ, "nfl_data.csv")

```


