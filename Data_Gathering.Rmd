---
title: "Data_Gathering"
output: html_document
---

```{r load_lib}
library(nflreadr)
library(tidyr)
library(dplyr)
```

```{r grab_pbp}

# Grab every play data
data <- load_pbp(2004:2024)

```

```{r filter_data}
subset <- subset(data,
       season_type == "REG" &
       (
         touchdown == 1 |
         (fourth_down_converted == 1 |
         fourth_down_failed == 1) |
         punt_inside_twenty == 1 |
         own_kickoff_recovery == 1 |
         extra_point_attempt == 1 |
         extra_point_result == "good" |
         field_goal_attempt == 1 |
         field_goal_result == "made" |
         return_touchdown == 1 |
         two_point_attempt == 1 |
         two_point_conv_result == "success" |
         pass_touchdown == 1 |
         rush_touchdown == 1 | 
         interception == 1 |
         fumble_lost == 1 |
         safety == 1
       ),
       select = c(
         season,
         game_id,
         home_team,
         away_team,
         home_score,
         away_score,
         season_type,
         posteam,
         defteam,
         fourth_down_failed,
         fourth_down_converted,
         td_team,
         touchdown,
         punt_inside_twenty,
         own_kickoff_recovery,
         extra_point_attempt,
         extra_point_result,
         field_goal_attempt,
         field_goal_result,
         return_touchdown,
         two_point_attempt,
         two_point_conv_result,
         pass_touchdown,
         rush_touchdown,
         interception,
         fumble_lost,
         safety))
```

```{r mutate_cols}
subset_mutated <- subset %>%
  mutate(
    fourth_down_attempt = (fourth_down_converted == 1 | fourth_down_failed == 1),
    extra_point_good = extra_point_result == "good",
    field_goal_made = field_goal_result == "made",
    two_point_success = two_point_conv_result == "success"
  )

```


```{r summarize}
data_summ <- subset_mutated %>%
  group_by(game_id, posteam) %>%
  summarize(
    season = first(season),
    home_team = first(home_team),
    away_team = first(away_team),
    home_score = first(home_score),
    away_score = first(away_score),
    touchdown = sum(touchdown == 1, na.rm = TRUE),
    fourth_down_attempt = sum(fourth_down_attempt == 1, na.rm = TRUE),
    punt_inside_twenty = sum(punt_inside_twenty == 1, na.rm = TRUE),
    own_kickoff_recovery = sum(own_kickoff_recovery == 1, na.rm = TRUE),
    extra_point_good = sum(extra_point_good == 1, na.rm = TRUE),
    field_goal_made = sum(field_goal_made == 1, na.rm = TRUE),
    return_touchdown = sum(return_touchdown == 1, na.rm = TRUE),
    two_point_success = sum(two_point_success == 1, na.rm = TRUE),
    pass_touchdown = sum(pass_touchdown == 1, na.rm = TRUE),
    rush_touchdown = sum(rush_touchdown == 1, na.rm = TRUE),
    interception = sum(interception == 1, na.rm = TRUE),
    fumble_lost = sum(fumble_lost == 1, na.rm = TRUE),
    safety = sum(safety == 1, na.rm = TRUE)
  )
```


```{r save_data}
write.csv(data_summ, "nfl_data.csv")
```








